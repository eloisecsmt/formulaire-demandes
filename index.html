<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Demandes Client - ZeenDoc</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Gestion des Demandes Client</h1>
            <p>S√©lectionnez le type de demande et compl√©tez les informations requises</p>
            <div class="zeendoc-info">
                <span class="zeendoc-badge">üìÅ Int√©gration ZeenDoc Automatique</span>
                <small>Documents automatiquement envoy√©s vers votre d√©p√¥t ZeenDoc + Email principal</small>
            </div>
        </div>

        <div class="form-container">
            <form id="demandeForm">
                <!-- S√©lection du type de demande -->
                <div class="form-section">
                    <div class="section-title">Type de demande</div>
                    <div class="type-selector">
                        <div class="type-card" data-type="versement">
                            <h3>Versement</h3>
                            <p>Ajout de fonds au patrimoine</p>
                        </div>
                        <div class="type-card" data-type="rachat">
                            <h3>Rachat</h3>
                            <p>Retrait de fonds</p>
                        </div>
                        <div class="type-card" data-type="arbitrage">
                            <h3>Arbitrage</h3>
                            <p>Patrimoine < 100k</p>
                        </div>
                        <div class="type-card" data-type="creation">
                            <h3>Cr√©ation</h3>
                            <p>Nouveau prospect/client</p>
                        </div>
                    </div>
                </div>

                <!-- Informations communes -->
                <div class="form-section">
                    <div class="section-title">Informations g√©n√©rales</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="nom">Nom du client *</label>
                            <input type="text" id="nom" name="nom" required>
                        </div>
                        <div class="form-group">
                            <label for="prenom">Pr√©nom du client *</label>
                            <input type="text" id="prenom" name="prenom" required>
                        </div>
                        <div class="form-group">
                            <label for="dateDemande">Date de la demande</label>
                            <input type="date" id="dateDemande" name="dateDemande" required>
                        </div>
                        <div class="form-group">
                            <label for="dateRdv">Date du prochain RDV</label>
                            <input type="date" id="dateRdv" name="dateRdv">
                        </div>
                        <div class="form-group">
                            <label for="urgence">Urgence</label>
                            <select id="urgence" name="urgence">
                                <option value="Normal">Normal</option>
                                <option value="Urgent">Urgent</option>
                                <option value="Tr√®s urgent">Tr√®s urgent</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="origine">Origine du contact</label>
                            <select id="origine" name="origine">
                                <option value="Client du PTF">Client du PTF</option>
                                <option value="Client apport√© par la direction">Client apport√© par la direction</option>
                                <option value="Client apport√© par un salari√© OC">Client apport√© par un salari√© OC</option>
                                <option value="Client apport√© par Progressia">Client apport√© par Progressia</option>
                                <option value="Client externe apporter par le CGP">Client externe apporter par le CGP</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="nouveauClient">Nouveau client ?</label>
                            <select id="nouveauClient" name="nouveauClient" required>
                                <option value="">S√©lectionner...</option>
                                <option value="Oui">Oui</option>
                                <option value="Non">Non</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="modeSignature">Mode de signature</label>
                            <select id="modeSignature" name="modeSignature">
                                <option value="Papier">Papier</option>
                                <option value="Electronique">Electronique</option>
                                <option value="RDV">RDV</option>
                                <option value="Mail/VP">Mail/VP</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="demandeur">Demandeur (qui fait la demande) *</label>
                            <input type="text" id="demandeur" name="demandeur" placeholder="Pr√©nom NOM" required>
                        </div>
                        <div class="form-group">
                            <label for="secteurDemandeur">Secteur/Localisation du demandeur *</label>
                            <select id="secteurDemandeur" name="secteurDemandeur" required>
                                <option value="">S√©lectionner...</option>
                                <option value="Le Havre">Le Havre</option>
                                <option value="Rouen">Rouen</option>
                                <option value="Paris">Paris</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Informations sp√©cifiques par type -->
                <div id="specificFields" class="form-section hidden">
                    <div class="section-title">Informations sp√©cifiques</div>
                    <div id="specificContent"></div>
                </div>

                <button type="submit" class="submit-btn" disabled>Envoyer automatiquement la demande</button>
            </form>
        </div>
    </div>

    <script>
        // Variables globales
        let selectedType = '';
        let requiredDocuments = [];
        let uploadedDocuments = {};

        // D√©finition des documents requis par type de demande
        const requiredDocumentsByType = {
            versement: [
                'majProfil_doc',
                'etudeSignee_doc', 
                'cniValide_doc',
                'justifDom_doc',
                'ribJour_doc',
                'justifProvenance_doc',
                'justifDomImpot_doc',
                'clauseBeneficiaire_doc'
            ],
            rachat: [
                'majProfilRachat_doc',
                'ribJourRachat_doc'
            ],
            arbitrage: [
                'majProfilArbitrage_doc'
            ],
            creation: [
                'ficheRenseignement_doc',
                'profilClientSigne_doc',
                'cartoClientSigne_doc',
                'lettreMiseRelation_doc',
                'filSigne_doc',
                'justifDomCreation_doc',
                'cniValideCreation_doc'
            ]
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            // D√©finir la date d'aujourd'hui
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateDemande').value = today;

            // √âv√©nements
            setupTypeSelection();
            setupFormSubmission();
        });

        function setupTypeSelection() {
            const typeCards = document.querySelectorAll('.type-card');
            typeCards.forEach(card => {
                card.addEventListener('click', function() {
                    // D√©s√©lectionner toutes les cartes
                    typeCards.forEach(c => c.classList.remove('active'));
                    // S√©lectionner la carte cliqu√©e
                    this.classList.add('active');
                    selectedType = this.dataset.type;
                    showSpecificFields(selectedType);
                });
            });
        }

        function showSpecificFields(type) {
            const specificFields = document.getElementById('specificFields');
            const specificContent = document.getElementById('specificContent');
            
            specificFields.classList.remove('hidden');
            specificContent.innerHTML = '';

            // D√©finir les documents requis pour ce type
            requiredDocuments = requiredDocumentsByType[type] || [];
            uploadedDocuments = {};

            switch(type) {
                case 'versement':
                    specificContent.innerHTML = createVersementFields();
                    break;
                case 'rachat':
                    specificContent.innerHTML = createRachatFields();
                    break;
                case 'arbitrage':
                    specificContent.innerHTML = createArbitrageFields();
                    break;
                case 'creation':
                    specificContent.innerHTML = createCreationFields();
                    break;
            }

            // Ajouter le message de validation avec info ZeenDoc
            const validationDiv = document.createElement('div');
            validationDiv.innerHTML = `
                <div class="validation-message" id="validationMessage">
                    Veuillez joindre au moins un document pour chaque cat√©gorie requise avant de pouvoir envoyer la demande.
                </div>
                <div class="zeendoc-workflow-info">
                    <h4>üöÄ Workflow Automatique</h4>
                    <ol>
                        <li><strong>Email Principal:</strong> Envoy√© avec archive ZIP si fichiers volumineux</li>
                        <li><strong>ZeenDoc:</strong> Fichiers originaux envoy√©s (emails multiples si n√©cessaire)</li>
                        <li><strong>Nommage:</strong> Format ZeenDoc appliqu√© automatiquement</li>
                        <li><strong>Suivi:</strong> Copies de confirmation envoy√©es</li>
                    </ol>
                    <div class="auto-info">
                        <span class="auto-badge">‚ö° Envoi automatique</span>
                    </div>
                </div>
            `;
            specificContent.appendChild(validationDiv);

            // Initialiser les √©v√©nements pour les nouveaux champs de fichiers
            setupFileEvents();
            updateSubmitButton();
        }

        function setupFileEvents() {
            const fileInputs = document.querySelectorAll('input[type="file"]');
            fileInputs.forEach(input => {
                input.addEventListener('change', function() {
                    const docId = this.id;
                    const docName = this.getAttribute('data-doc-name');
                    handleDocumentUpload(docId, docName);
                });
            });

            // √âv√©nements drag & drop
            const fileUploads = document.querySelectorAll('.file-upload');
            fileUploads.forEach(upload => {
                upload.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    this.classList.add('dragover');
                });

                upload.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                });

                upload.addEventListener('drop', function(e) {
                    e.preventDefault();
                    this.classList.remove('dragover');
                    const input = this.querySelector('input[type="file"]');
                    if (input && e.dataTransfer.files.length > 0) {
                        input.files = e.dataTransfer.files;
                        const docId = input.id;
                        const docName = input.getAttribute('data-doc-name');
                        handleDocumentUpload(docId, docName);
                    }
                });
            });
        }

        function handleDocumentUpload(inputId, docName) {
            const input = document.getElementById(inputId);
            const fileList = document.getElementById(inputId + '_list');
            
            // R√©cup√©rer les infos du client
            const nom = document.getElementById('nom').value;
            const prenom = document.getElementById('prenom').value;
            const typeDemande = selectedType;
            
            if (!uploadedDocuments[inputId]) {
                uploadedDocuments[inputId] = [];
            }
        
            if (input.files.length > 0) {
                Array.from(input.files).forEach(file => {
                    // G√©n√©rer le nom ZeenDoc automatiquement
                    const nomZeenDoc = genererNomZeenDoc(file.name, nom, prenom, typeDemande, inputId);
                    
                    // V√©rifier si le fichier n'est pas d√©j√† dans la liste
                    const exists = uploadedDocuments[inputId].some(existingFile => 
                        existingFile.name === file.name && existingFile.size === file.size
                    );
                    
                    if (!exists) {
                        uploadedDocuments[inputId].push({
                            file: file,
                            name: docName,
                            nomOriginal: file.name,
                            nomZeenDoc: nomZeenDoc,
                            id: Date.now() + Math.random()
                        });
                    }
                });
        
                updateFileList(inputId);
            }
        
            input.value = '';
            updateSubmitButton();
        }

        function genererNomZeenDoc(nomFichier, nom, prenom, typeDemande, docId) {
            // Extraire l'extension
            const extension = nomFichier.includes('.') ? nomFichier.split('.').pop().toLowerCase() : '';
            
            // Mapper les IDs vers des noms courts
            const mappingDocs = {
                'majProfil_doc': 'MAJ_Profil',
                'etudeSignee_doc': 'Etude_Signee',
                'cniValide_doc': 'CNI',
                'justifDom_doc': 'Justif_Domicile',
                'ribJour_doc': 'RIB',
                'justifProvenance_doc': 'Justif_Provenance',
                'justifDomImpot_doc': 'Justif_Dom_Impot',
                'clauseBeneficiaire_doc': 'Clause_Beneficiaire',
                'majProfilRachat_doc': 'MAJ_Profil',
                'ribJourRachat_doc': 'RIB',
                'majProfilArbitrage_doc': 'MAJ_Profil',
                'ficheRenseignement_doc': 'Fiche_Renseignement',
                'profilClientSigne_doc': 'Profil_Client',
                'cartoClientSigne_doc': 'Cartographie',
                'lettreMiseRelation_doc': 'Lettre_Relation',
                'filSigne_doc': 'FIL',
                'justifDomCreation_doc': 'Justif_Domicile',
                'cniValideCreation_doc': 'CNI'
            };
            
            const docType = mappingDocs[docId] || 'Document';
            const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
            
            if (!nom || !prenom) {
                return `${typeDemande.toUpperCase()}_${docType}_${dateStr}${extension ? '.' + extension : ''}`;
            }
            
            return `${typeDemande.toUpperCase()}_${nom.toUpperCase()}_${prenom}_${docType}_${dateStr}${extension ? '.' + extension : ''}`;
        }

        function updateFileList(inputId) {
            const fileList = document.getElementById(inputId + '_list');
            const files = uploadedDocuments[inputId] || [];
        
            if (files.length > 0) {
                fileList.classList.remove('hidden');
                fileList.innerHTML = '';
        
                files.forEach((fileData, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item zeendoc-item';
                    
                    const fileSize = formatFileSize(fileData.file.size);
                    
                    fileItem.innerHTML = `
                        <div class="file-item-info">
                            <span class="file-item-icon">üìÑ</span>
                            <div>
                                <div class="file-item-name-original">${fileData.nomOriginal}</div>
                                <div class="file-item-name-zeendoc">üìÅ ZeenDoc: ${fileData.nomZeenDoc}</div>
                                <div class="file-item-size">${fileSize}</div>
                            </div>
                        </div>
                        <button type="button" class="file-item-remove" onclick="removeDocumentFile('${inputId}', ${index})">Supprimer</button>
                    `;
                    fileList.appendChild(fileItem);
                });
        
                // Bouton pour ajouter plus de fichiers
                const addMoreBtn = document.createElement('button');
                addMoreBtn.type = 'button';
                addMoreBtn.className = 'add-more-files';
                addMoreBtn.textContent = 'Ajouter un autre fichier';
                addMoreBtn.onclick = () => document.getElementById(inputId).click();
                fileList.appendChild(addMoreBtn);
            } else {
                fileList.classList.add('hidden');
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function removeDocumentFile(inputId, index) {
            if (uploadedDocuments[inputId]) {
                uploadedDocuments[inputId].splice(index, 1);
                
                if (uploadedDocuments[inputId].length === 0) {
                    delete uploadedDocuments[inputId];
                }
                
                updateFileList(inputId);
                updateSubmitButton();
            }
        }

        function updateSubmitButton() {
            const submitBtn = document.querySelector('.submit-btn');
            const validationMessage = document.getElementById('validationMessage');
            
            if (!selectedType || requiredDocuments.length === 0) {
                submitBtn.disabled = true;
                return;
            }

            // V√©rifier si au moins un document est upload√© pour chaque cat√©gorie requise
            const allDocumentsUploaded = requiredDocuments.every(docId => 
                uploadedDocuments[docId] && uploadedDocuments[docId].length > 0
            );

            if (allDocumentsUploaded) {
                submitBtn.disabled = false;
                if (validationMessage) {
                    validationMessage.classList.remove('show');
                }
            } else {
                submitBtn.disabled = true;
                if (validationMessage) {
                    validationMessage.classList.add('show');
                }
            }
        }

        function createDocumentField(id, label, helpText, isRequired = true) {
            const requiredMark = isRequired ? '<span class="required">*</span>' : '';
            return `
                <div class="document-field zeendoc-field">
                    <label>${label}${requiredMark}</label>
                    <div class="file-upload">
                        <span class="file-upload-icon">üìé</span>
                        <div class="file-upload-text">
                            <p>Glissez vos fichiers ici ou cliquez pour s√©lectionner</p>
                            <small class="zeendoc-naming">üöÄ Envoi automatique vers ZeenDoc</small>
                        </div>
                        <span class="file-upload-btn">Parcourir</span>
                        <input type="file" id="${id}" data-doc-name="${label}" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                    </div>
                    <div class="file-help-text">${helpText}</div>
                    <div class="file-help-text formats">Formats accept√©s: PDF, DOC, DOCX, JPG, PNG</div>
                    <div id="${id}_list" class="file-list hidden"></div>
                </div>
            `;
        }

        function createVersementFields() {
            return `
                <div class="document-fields">
                    ${createDocumentField('majProfil_doc', 'MAJ & profil sign√©s', 'Document de mise √† jour et profil client sign√©s (validit√© 12 mois)')}
                    ${createDocumentField('etudeSignee_doc', 'Etude sign√©e', '√âtude financi√®re sign√©e par le client')}
                    ${createDocumentField('cniValide_doc', 'CNI en cours de validit√©', 'Carte nationale d\'identit√© en cours de validit√©')}
                    ${createDocumentField('justifDom_doc', 'Justificatif de domicile et avis d\'imposition', 'Justificatif de domicile de moins de 3 mois ET dernier avis d\'imposition')}
                    ${createDocumentField('ribJour_doc', 'RIB √† jour', 'Relev√© d\'identit√© bancaire r√©cent')}
                    ${createDocumentField('justifProvenance_doc', 'Justificatif de provenance des fonds', 'Bulletin de salaire, relev√© √©pargne, acte succession, donation, vente, certificat cession, attestation employeur, etc.')}
                    ${createDocumentField('justifDomImpot_doc', 'Justificatif domicile et imp√¥t (copie)', 'Copie suppl√©mentaire du justificatif de domicile ET avis d\'imposition')}
                    ${createDocumentField('clauseBeneficiaire_doc', 'Clause b√©n√©ficiaire', 'Document de d√©signation des b√©n√©ficiaires')}
                </div>

                <div class="form-cards-container">
                    <div class="form-card">
                        <div class="card-header">
                            <span class="card-icon">üí∞</span>
                            <h3>Informations financi√®res</h3>
                        </div>
                        <div class="form-group">
                            <label for="typeVersement">Type de versement *</label>
                            <select id="typeVersement" name="typeVersement" required>
                                <option value="">S√©lectionner...</option>
                                <option value="Versement initial (souscription)">Versement initial (souscription)</option>
                                <option value="Versement suppl√©mentaire">Versement suppl√©mentaire</option>
                                <option value="PP (Programmation de versements)">PP (Programmation de versements)</option>
                            </select>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <label for="montantVersement">Montant du versement (‚Ç¨) *</label>
                                <input type="number" id="montantVersement" name="montantVersement" min="0" step="0.01" required>
                            </div>
                            <div class="form-group field-with-tooltip">
                                <label for="allocationVersement">
                                    Allocation du versement *
                                    <span class="tooltip-icon">?
                                        <div class="tooltip-content">
                                            <div class="tooltip-example">
                                                Ex: Fonds euros 60% - OPCVM actions 25% - Obligations 15%
                                            </div>
                                        </div>
                                    </span>
                                </label>
                                <textarea id="allocationVersement" name="allocationVersement" placeholder="V√©rifier que les diff√©rents supports sont toujours commercialis√©s" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="fraisVersement">Frais du versement (%) *</label>
                                <input type="number" id="fraisVersement" name="fraisVersement" min="0" max="100" step="0.01" required>
                            </div>
                        </div>
                    </div>

                    <div class="form-card">
                        <div class="card-header">
                            <span class="card-icon">üîÑ</span>
                            <h3>Provenance et tra√ßabilit√©</h3>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <label for="provenanceFonds">Provenance des fonds *</label>
                                <select id="provenanceFonds" name="provenanceFonds" required>
                                    <option value="">S√©lectionner...</option>
                                    <option value="Salaire">Salaire</option>
                                    <option value="Epargne personnelle">√âpargne personnelle</option>
                                    <option value="H√©ritage">H√©ritage</option>
                                    <option value="Donation">Donation</option>
                                    <option value="Vente immobili√®re">Vente immobili√®re</option>
                                    <option value="Vente mobili√®re">Vente mobili√®re</option>
                                    <option value="Indemnit√©s">Indemnit√©s</option>
                                    <option value="Prime">Prime</option>
                                    <option value="Rachat assurance vie">Rachat assurance vie</option>
                                    <option value="Liquidation retraite">Liquidation retraite</option>
                                    <option value="Revenus locatifs">Revenus locatifs</option>
                                    <option value="Plus-value financi√®re">Plus-value financi√®re</option>
                                    <option value="Autre">Autre</option>
                                </select>
                            </div>
                            <div class="form-group field-with-tooltip">
                                <label for="cheminArgent">
                                    Chemin de l'argent - Comptes de transit *
                                    <span class="tooltip-icon">?
                                        <div class="tooltip-content">
                                            <div class="tooltip-example">
                                                Ex: Salaire ‚Üí Compte courant ‚Üí Livret A ‚Üí Versement
                                            </div>
                                        </div>
                                    </span>
                                </label>
                                <textarea id="cheminArgent" name="cheminArgent" placeholder="Ex: Salaire ‚Üí Compte courant BNP ‚Üí Livret A ‚Üí Compte courant pour versement" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="justifCompteTransit">Justificatif compte de transit *</label>
                                <select id="justifCompteTransit" name="justifCompteTransit" required>
                                    <option value="">S√©lectionner...</option>
                                    <option value="Relev√© de compte courant">Relev√© de compte courant</option>
                                    <option value="Relev√© de livret A">Relev√© de livret A</option>
                                    <option value="Relev√© LDD">Relev√© LDD</option>
                                    <option value="Relev√© LEP">Relev√© LEP</option>
                                    <option value="Relev√© CEL">Relev√© CEL</option>
                                    <option value="Relev√© PEL">Relev√© PEL</option>
                                    <option value="Relev√© livret jeune">Relev√© livret jeune</option>
                                    <option value="Relev√© compte sur livret">Relev√© compte sur livret</option>
                                    <option value="Relev√© de compte √† terme">Relev√© de compte √† terme</option>
                                    <option value="Relev√© PEA">Relev√© PEA</option>
                                    <option value="Relev√© compte titres">Relev√© compte titres</option>
                                    <option value="Relev√© assurance vie">Relev√© assurance vie</option>
                                    <option value="Relev√© compte joint">Relev√© compte joint</option>
                                    <option value="Relev√© compte professionnel">Relev√© compte professionnel</option>
                                    <option value="Plusieurs relev√©s de comptes">Plusieurs relev√©s de comptes</option>
                                    <option value="Autre relev√© de compte">Autre relev√© de compte</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-card">
                        <div class="card-header">
                            <span class="card-icon">üë•</span>
                            <h3>B√©n√©ficiaires et clauses</h3>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <label for="clauseBeneficiaireType">Type de clause b√©n√©ficiaire *</label>
                                <select id="clauseBeneficiaireType" name="clauseBeneficiaireType" required>
                                    <option value="">S√©lectionner...</option>
                                    <option value="Standard">Standard</option>
                                    <option value="Personnalis√©">Personnalis√©</option>
                                </select>
                            </div>
                            <div class="form-group field-with-tooltip">
                                <label for="clauseBeneficiaireSpec">
                                    Sp√©cification des b√©n√©ficiaires *
                                    <span class="tooltip-icon">?
                                        <div class="tooltip-content">
                                            <div class="tooltip-example">
                                                NOM Pr√©nom - DD/MM/AAAA Ville - XX%<br>
                                                Ex: MARTIN Jean - 15/03/1980 Paris - 50%
                                            </div>
                                        </div>
                                    </span>
                                </label>
                                <textarea id="clauseBeneficiaireSpec" name="clauseBeneficiaireSpec" placeholder="Format: NOM Pr√©nom - DD/MM/AAAA Ville - XX%" required></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createRachatFields() {
            return `
                <div class="document-fields">
                    ${createDocumentField('majProfilRachat_doc', 'MAJ & profil sign√©s', 'Document de mise √† jour et profil client sign√©s (validit√© 12 mois)')}
                    ${createDocumentField('ribJourRachat_doc', 'RIB √† jour', 'Relev√© d\'identit√© bancaire r√©cent pour le virement')}
                </div>

                <div class="form-cards-container">
                    <div class="form-card">
                        <div class="card-header">
                            <span class="card-icon">üí∞</span>
                            <h3>Informations financi√®res</h3>
                        </div>
                        <div class="form-group">
                            <label for="typeRachat">Type de rachat *</label>
                            <select id="typeRachat" name="typeRachat" required>
                                <option value="">S√©lectionner...</option>
                                <option value="Rachat total">Rachat total</option>
                                <option value="Rachat partiel">Rachat partiel</option>
                            </select>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <label for="montantRachat">Montant du rachat (‚Ç¨) *</label>
                                <input type="number" id="montantRachat" name="montantRachat" min="0" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="fiscaliteRachat">Fiscalit√© du rachat *</label>
                                <select id="fiscaliteRachat" name="fiscaliteRachat" required>
                                    <option value="">S√©lectionner...</option>
                                    <option value="IR">IR (Imp√¥t sur le Revenu)</option>
                                    <option value="PFU">PFU (Pr√©l√®vement Forfaitaire Unique)</option>
                                    <option value="PFL">PFL (Pr√©l√®vement Forfaitaire Lib√©ratoire)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="motifRachat">Motif du rachat *</label>
                                <select id="motifRachat" name="motifRachat" required>
                                    <option value="">S√©lectionner...</option>
                                    <option value="Besoin de liquidit√©s">Besoin de liquidit√©s</option>
                                    <option value="Achat immobilier">Achat immobilier</option>
                                    <option value="Travaux">Travaux</option>
                                    <option value="Frais de sant√©">Frais de sant√©</option>
                                    <option value="Frais de scolarit√©">Frais de scolarit√©</option>
                                    <option value="Voyage">Voyage</option>
                                    <option value="Investissement">Investissement</option>
                                    <option value="Autre">Autre</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-card">
                        <div class="card-header">
                            <span class="card-icon">üìä</span>
                            <h3>Supports et r√©allocation</h3>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <label for="supportDesinvestir">Support √† d√©sinvestir *</label>
                                <input type="text" id="supportDesinvestir" name="supportDesinvestir" required>
                            </div>
                            <div class="form-group">
                                <label for="pourcentageReallouer">Pourcentage √† r√©alouer (%) *</label>
                                <input type="number" id="pourcentageReallouer" name="pourcentageReallouer" min="0" max="100" step="0.1" required>
                            </div>
                            <div class="form-group">
                                <label for="nouveauSupport">Nouveau support *</label>
                                <input type="text" id="nouveauSupport" name="nouveauSupport" required>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createArbitrageFields() {
            return `
                <div class="document-fields">
                    ${createDocumentField('majProfilArbitrage_doc', 'MAJ & profil sign√©s', 'Document de mise √† jour et profil client sign√©s (validit√© 12 mois)')}
                </div>

                <div class="form-cards-container">
                    <div class="form-card">
                        <div class="card-header">
                            <span class="card-icon">üí∞</span>
                            <h3>Allocation financi√®re</h3>
                        </div>
                        <div class="card-content">
                            <div class="form-group">
                                <label for="allocationArbitrage">Montant de l'allocation (‚Ç¨) *</label>
                                <input type="number" id="allocationArbitrage" name="allocationArbitrage" min="0" step="0.01" required>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function createCreationFields() {
            return `
                <div class="document-fields">
                    ${createDocumentField('ficheRenseignement_doc', 'Fiche de renseignement sign√©e', 'Fiche client compl√®te avec informations personnelles et financi√®res')}
                    ${createDocumentField('profilClientSigne_doc', 'Profil client sign√©', 'Document de profilage financier sign√© par le client')}
                    ${createDocumentField('cartoClientSigne_doc', 'Cartographie client sign√©e', 'Document de cartographie patrimoniale sign√©')}
                    ${createDocumentField('lettreMiseRelation_doc', 'Lettre de mise en relation sign√©e', 'Lettre officielle de mise en relation sign√©e')}
                    ${createDocumentField('filSigne_doc', 'FIL sign√©', 'Document FIL (Fiche d\'Information L√©gale) sign√©')}
                    ${createDocumentField('justifDomCreation_doc', 'Justificatif domicile et avis d\'imposition', 'Justificatif de domicile de moins de 3 mois ET dernier avis d\'imposition')}
                    ${createDocumentField('cniValideCreation_doc', 'CNI en cours de validit√©', 'Carte nationale d\'identit√© en cours de validit√©')}
                </div>
            `;
        }

        function setupFormSubmission() {
            const form = document.getElementById('demandeForm');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                if (!selectedType) {
                    alert('Veuillez s√©lectionner un type de demande');
                    return;
                }

                // Cr√©er FormData avec tous les champs + fichiers
                const formData = new FormData(form);
                
                // Ajouter le type de demande
                formData.append('type', selectedType);
                
                // Ajouter tous les fichiers upload√©s
                Object.keys(uploadedDocuments).forEach(docId => {
                    const files = uploadedDocuments[docId];
                    files.forEach((fileData, index) => {
                        formData.append(docId, fileData.file);
                    });
                });

                // Envoyer au backend
                const submitBtn = document.querySelector('.submit-btn');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Envoi automatique en cours...';

                fetch('/envoyer-demande', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        let message = '‚úÖ Demande envoy√©e automatiquement avec succ√®s!\n\n';
                        
                        if (data.fichiers_count > 0) {
                            message += `üìÅ ${data.fichiers_count} document(s) trait√©(s):\n`;
                            data.fichiers_info.forEach(nom => {
                                message += `‚Ä¢ ${nom}\n`;
                            });
                            message += '\n';
                        }
                        
                        if (data.envoi_auto) {
                            message += 'üöÄ ENVOIS AUTOMATIQUES R√âUSSIS:\n\n';
                            
                            // Email principal
                            if (data.details_envoi.email_principal) {
                                message += 'üìß Email principal: ‚úÖ Envoy√©\n';
                            }
                            
                            // Emails ZeenDoc
                            if (data.details_envoi.total_emails_zeendoc > 0) {
                                if (data.details_envoi.total_emails_zeendoc > 1) {
                                    message += `üìÅ ZeenDoc: ${data.details_envoi.total_emails_zeendoc} emails envoy√©s (fichiers volumineux)\n`;
                                    data.details_envoi.zeendoc_parties.forEach(partie => {
                                        const status = partie.succes ? '‚úÖ' : '‚ùå';
                                        message += `   ‚îî‚îÄ Partie ${partie.partie}: ${status} ${partie.fichiers_count} fichier(s)\n`;
                                    });
                                } else {
                                    message += 'üìÅ ZeenDoc: ‚úÖ Email envoy√©\n';
                                }
                            }
                            
                            message += '\nüéâ Tous les destinataires ont √©t√© notifi√©s automatiquement !';
                            
                        } else {
                            message += '‚ùå Erreur lors de l\'envoi automatique.\n';
                            message += 'Veuillez v√©rifier votre configuration SMTP.';
                        }
                        
                        alert(message);
                        
                        // R√©initialiser le formulaire
                        resetForm();
                        
                    } else {
                        alert('‚ùå Erreur lors de l\'envoi: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('‚ùå Erreur technique lors de l\'envoi. Veuillez r√©essayer.');
                })
                .finally(() => {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Envoyer automatiquement la demande';
                    updateSubmitButton();
                });
            });
        }

        function resetForm() {
            const form = document.getElementById('demandeForm');
            form.reset();
            document.querySelectorAll('.type-card').forEach(card => card.classList.remove('active'));
            document.getElementById('specificFields').classList.add('hidden');
            selectedType = '';
            requiredDocuments = [];
            uploadedDocuments = {};
            
            // Remettre la date d'aujourd'hui
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateDemande').value = today;
        }
    </script>
</body>
</html>

